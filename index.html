<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BetterStudio — Delivery Metrics</title>
<style>
:root {
  --bg:#0E0D0B;--surface:#141311;--card:#1A1815;
  --border:#272420;--border2:#322E28;--text:#EDE8DF;--muted:#6E6860;--faint:#2A2620;
  --green:#72C484;--amber:#E5A832;--blue:#5B9BD5;--rose:#D96B6B;--cream:#C8BFB0;
  --green-bg:rgba(114,196,132,.10);--amber-bg:rgba(229,168,50,.10);
  --blue-bg:rgba(91,155,213,.10);--rose-bg:rgba(217,107,107,.10);
  --serif:Georgia,'Times New Roman',serif;
  --mono:'Courier New',Courier,monospace;
  --sans:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;}

#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:#1F1C18;border:1px solid var(--border2);color:var(--cream);padding:10px 18px;border-radius:10px;font-family:var(--mono);font-size:11px;z-index:999;transition:transform .3s cubic-bezier(.4,0,.2,1);pointer-events:none;display:flex;align-items:center;gap:8px;}
#toast.show{transform:translateX(-50%) translateY(0);}
#activity-feed{position:fixed;bottom:24px;right:20px;width:260px;display:flex;flex-direction:column;gap:6px;z-index:998;pointer-events:none;}
.activity-item{background:#1A1815;border:1px solid var(--border2);border-radius:10px;padding:9px 13px;font-family:var(--mono);font-size:10px;color:var(--cream);animation:slideIn .3s ease;display:flex;align-items:center;gap:8px;line-height:1.5;}
.a-avatar{width:20px;height:20px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;}
@keyframes slideIn{from{opacity:0;transform:translateX(20px);}to{opacity:1;transform:translateX(0);}}
@keyframes fadeOut{to{opacity:0;transform:translateY(10px);}}

.live-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;background:rgba(114,196,132,.12);border:1px solid rgba(114,196,132,.28);font-family:var(--mono);font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--green);}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 1.8s infinite;}
.live-badge.syncing{background:rgba(229,168,50,.12);border-color:rgba(229,168,50,.28);color:var(--amber);}
.live-badge.syncing .live-dot{background:var(--amber);animation:none;}
.live-badge.error{background:rgba(217,107,107,.12);border-color:rgba(217,107,107,.28);color:var(--rose);}
.live-badge.error .live-dot{background:var(--rose);animation:none;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}

.header{padding:22px 36px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;}
.eyebrow{font-family:var(--mono);font-size:9px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.h-left h1{font-family:var(--serif);font-size:34px;font-weight:700;line-height:1;}
.h-right{display:flex;align-items:center;gap:14px;flex-wrap:wrap;}
.h-stat{font-family:var(--mono);font-size:10px;color:var(--muted);line-height:1.8;}
.h-stat b{color:var(--cream);}
#presence-bar{display:flex;align-items:center;gap:4px;}
.presence-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;border:2px solid var(--bg);margin-left:-6px;position:relative;cursor:default;transition:transform .15s;font-family:var(--mono);}
.presence-avatar:first-child{margin-left:0;}
.presence-avatar:hover{transform:scale(1.15);z-index:10;}
.presence-avatar .tip{position:absolute;bottom:calc(100%+6px);left:50%;transform:translateX(-50%);background:#1F1C18;border:1px solid var(--border2);border-radius:6px;padding:4px 9px;font-family:var(--mono);font-size:9px;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .15s;}
.presence-avatar:hover .tip{opacity:1;}
#online-count{font-family:var(--mono);font-size:10px;color:var(--muted);}

.stats-bar{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);border-bottom:1px solid var(--border);}
.stat-cell{background:var(--surface);padding:16px 22px;position:relative;overflow:hidden;}
.stat-cell::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.sc-green::before{background:var(--green);}.sc-amber::before{background:var(--amber);}
.sc-blue::before{background:var(--blue);}.sc-rose::before{background:var(--rose);}
.stat-label{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.15em;color:var(--muted);margin-bottom:4px;}
.stat-row{display:flex;align-items:baseline;gap:7px;}
.stat-num{font-family:var(--serif);font-size:36px;font-weight:700;line-height:1;transition:transform .25s;}
.stat-num.bump{transform:scale(1.18);}
.stat-pct{font-family:var(--mono);font-size:11px;}
.s-green{color:var(--green);}.s-amber{color:var(--amber);}.s-blue{color:var(--blue);}.s-rose{color:var(--rose);}

.health-wrap{padding:12px 36px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px;}
.health-track{flex:1;height:5px;background:var(--faint);border-radius:100px;overflow:hidden;display:flex;}
.health-seg{height:100%;transition:width .5s cubic-bezier(.4,0,.2,1);}
.health-legend{display:flex;gap:12px;flex-shrink:0;}
.hl{display:flex;align-items:center;gap:4px;font-family:var(--mono);font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;}
.hl-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.bg-green{background:var(--green);}.bg-amber{background:var(--amber);}.bg-blue{background:var(--blue);}.bg-rose{background:var(--rose);}

.view{display:none;}.view.active{display:block;}
#overview{padding:24px 36px 80px;}
.section-title{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.16em;color:var(--muted);margin-bottom:14px;}
.looks-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;}
.look-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:border-color .15s,transform .15s,box-shadow .15s;position:relative;overflow:hidden;}
.look-card:hover{border-color:var(--border2);transform:translateY(-1px);box-shadow:0 6px 24px rgba(0,0,0,.3);}
.look-card.has-issues{border-color:rgba(217,107,107,.25);}
.look-card.all-done{border-color:rgba(114,196,132,.25);}
.look-card.remote-flash{animation:remoteFlash .8s ease;}
@keyframes remoteFlash{0%{box-shadow:0 0 0 2px rgba(91,155,213,.6);background:#1c2230;}100%{box-shadow:none;background:var(--card);}}
.lc-num{font-family:var(--mono);font-size:11px;font-weight:500;text-transform:uppercase;letter-spacing:.14em;margin-bottom:5px;}
.lc-products{display:flex;flex-direction:column;gap:4px;min-height:36px;}
.lc-product{display:flex;align-items:center;justify-content:space-between;gap:6px;}
.lc-pname{font-size:11px;color:var(--cream);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.lc-status{width:20px;height:20px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;}
.lc-empty{font-family:var(--mono);font-size:10px;color:var(--muted);font-style:italic;}
.lc-footer{margin-top:10px;padding-top:10px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.lc-bar{flex:1;height:4px;background:var(--faint);border-radius:100px;overflow:hidden;display:flex;margin-right:10px;}
.lc-bar-seg{height:100%;}
.lc-edit{font-family:var(--mono);font-size:9px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;}
.lc-arrow{transition:transform .15s;}.look-card:hover .lc-arrow{transform:translateX(2px);}
.lc-viewers{position:absolute;top:10px;right:10px;display:flex;}
.lc-viewer-dot{width:7px;height:7px;border-radius:50%;border:1.5px solid var(--card);margin-left:-2px;}

#drill{padding:24px 36px 80px;}
.back-btn{display:inline-flex;align-items:center;gap:7px;background:none;border:1px solid var(--border);color:var(--muted);font-family:var(--mono);font-size:10px;letter-spacing:.1em;text-transform:uppercase;padding:7px 13px;border-radius:8px;cursor:pointer;margin-bottom:24px;transition:all .15s;}
.back-btn:hover{color:var(--text);border-color:var(--border2);}
.drill-top{display:flex;align-items:flex-start;justify-content:space-between;gap:20px;margin-bottom:24px;flex-wrap:wrap;}
.drill-name{font-family:var(--serif);font-size:46px;font-weight:700;line-height:1;}
.drill-sub{font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:5px;letter-spacing:.08em;}
.add-panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 18px;width:280px;flex-shrink:0;}
.add-panel-title{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.14em;color:var(--muted);margin-bottom:10px;}
.add-row{display:flex;gap:6px;}
.add-input{flex:1;background:var(--faint);border:1px solid var(--border2);border-radius:7px;padding:8px 11px;font-family:var(--sans);font-size:12px;color:var(--text);outline:none;transition:border-color .15s;}
.add-input:focus{border-color:var(--muted);}
.add-input::placeholder{color:var(--muted);}
.add-btn{padding:8px 13px;background:var(--faint);border:1px solid var(--border2);border-radius:7px;color:var(--text);font-family:var(--mono);font-size:10px;cursor:pointer;transition:background .15s;white-space:nowrap;}
.add-btn:hover{background:var(--border2);}
.products-table{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;}
.pt-header{display:grid;grid-template-columns:1fr repeat(4,76px) 32px;padding:10px 20px;border-bottom:1px solid var(--border);gap:8px;}
.pt-th{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);text-align:center;}
.pt-th:first-child{text-align:left;}
.product-row{display:grid;grid-template-columns:1fr repeat(4,76px) 32px;padding:12px 20px;border-bottom:1px solid var(--border);gap:8px;align-items:center;transition:background .12s;}
.product-row:last-child{border-bottom:none;}
.product-row:hover{background:rgba(255,255,255,.02);}
.product-row.remote-updated{animation:rowRemote .7s ease;}
@keyframes rowRemote{0%{background:rgba(91,155,213,.15);}100%{background:transparent;}}
.pr-name{font-size:13px;font-weight:500;color:var(--text);}
.pr-tag{font-size:10px;font-family:var(--mono);margin-top:2px;}
.status-btn{display:flex;align-items:center;justify-content:center;height:32px;border-radius:7px;border:1px solid var(--border2);background:none;cursor:pointer;font-size:12px;transition:all .15s;color:var(--muted);}
.status-btn:hover{border-color:var(--muted);color:var(--text);}
.status-btn.active-green{background:var(--green-bg);border-color:rgba(114,196,132,.35);color:var(--green);}
.status-btn.active-amber{background:var(--amber-bg);border-color:rgba(229,168,50,.35);color:var(--amber);}
.status-btn.active-blue{background:var(--blue-bg);border-color:rgba(91,155,213,.35);color:var(--blue);}
.status-btn.active-rose{background:var(--rose-bg);border-color:rgba(217,107,107,.35);color:var(--rose);}
.del-btn{display:flex;align-items:center;justify-content:center;width:28px;height:28px;border:none;background:none;color:var(--muted);cursor:pointer;border-radius:6px;font-size:14px;transition:all .15s;}
.del-btn:hover{background:var(--rose-bg);color:var(--rose);}
.empty-state{padding:38px 20px;text-align:center;font-family:var(--mono);font-size:11px;color:var(--muted);}
.status-legend{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;}
.sl-item{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:7px;border:1px solid var(--border);font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);}
.whos-here{display:flex;align-items:center;gap:6px;margin-bottom:16px;padding:8px 14px;background:var(--card);border:1px solid var(--border);border-radius:10px;width:fit-content;}
.wh-label{font-family:var(--mono);font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em;margin-right:4px;}
@media(max-width:700px){
  .stats-bar{grid-template-columns:1fr 1fr;}
  .looks-grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr));}
  .pt-header,.product-row{grid-template-columns:1fr repeat(4,50px) 28px;}
  .header,.health-wrap,#overview,#drill{padding-left:18px;padding-right:18px;}
  .drill-top{flex-direction:column;}.add-panel{width:100%;}
  #activity-feed{display:none;}
}
</style>
</head>
<body>
<div id="toast"><span id="toast-icon">✓</span><span id="toast-msg">Saved</span></div>
<div id="activity-feed"></div>
<div class="header">
  <div class="h-left">
    <div class="eyebrow">BetterStudio · Bytimo D-N2</div>
    <h1>Delivery Metrics</h1>
  </div>
  <div class="h-right">
    <div class="h-stat">Products <b id="hdr-products">0</b> · Looks <b id="hdr-logged">0/26</b></div>
    <div id="presence-bar"></div>
    <div id="online-count"></div>
    <div class="live-badge" id="live-badge"><div class="live-dot"></div><span id="live-label">Connecting…</span></div>
  </div>
</div>
<div class="stats-bar">
  <div class="stat-cell sc-green"><div class="stat-label">✓ First Generation</div><div class="stat-row"><div class="stat-num s-green" id="g-first">0</div><div class="stat-pct s-green" id="g-first-pct">0%</div></div></div>
  <div class="stat-cell sc-amber"><div class="stat-label">↻ Regeneration</div><div class="stat-row"><div class="stat-num s-amber" id="g-regen">0</div><div class="stat-pct s-amber" id="g-regen-pct">0%</div></div></div>
  <div class="stat-cell sc-blue"><div class="stat-label">✦ AI Edit</div><div class="stat-row"><div class="stat-num s-blue" id="g-ai">0</div><div class="stat-pct s-blue" id="g-ai-pct">0%</div></div></div>
  <div class="stat-cell sc-rose"><div class="stat-label">✎ Manual Edit</div><div class="stat-row"><div class="stat-num s-rose" id="g-manual">0</div><div class="stat-pct s-rose" id="g-manual-pct">0%</div></div></div>
</div>
<div class="health-wrap">
  <div class="health-track">
    <div class="health-seg bg-green" id="hbar-first" style="width:0%"></div>
    <div class="health-seg bg-amber" id="hbar-regen" style="width:0%"></div>
    <div class="health-seg bg-blue"  id="hbar-ai"    style="width:0%"></div>
    <div class="health-seg bg-rose"  id="hbar-manual" style="width:0%"></div>
  </div>
  <div class="health-legend">
    <div class="hl"><div class="hl-dot bg-green"></div>First</div>
    <div class="hl"><div class="hl-dot bg-amber"></div>Regen</div>
    <div class="hl"><div class="hl-dot bg-blue"></div>AI</div>
    <div class="hl"><div class="hl-dot bg-rose"></div>Manual</div>
  </div>
</div>
<div class="view active" id="overview">
  <div style="padding:24px 36px 0;"><div class="section-title">26 Looks — click any to log &amp; update products</div></div>
  <div style="padding:12px 36px 0;"><div class="looks-grid" id="looks-grid"></div></div>
</div>
<div class="view" id="drill">
  <button class="back-btn" onclick="goOverview()">← All Looks</button>
  <div id="whos-here-drill" class="whos-here" style="display:none;"></div>
  <div class="drill-top">
    <div><div class="drill-name" id="d-title">Look 1</div><div class="drill-sub" id="d-sub"></div></div>
    <div class="add-panel">
      <div class="add-panel-title">Add product to this look</div>
      <div class="add-row">
        <input class="add-input" id="new-product-input" placeholder="e.g. Silk Dress" onkeydown="if(event.key==='Enter')addProduct()">
        <button class="add-btn" onclick="addProduct()">+ Add</button>
      </div>
    </div>
  </div>
  <div class="status-legend">
    <div class="sl-item" style="border-color:rgba(114,196,132,.3);color:var(--green);">✓ First gen</div>
    <div class="sl-item" style="border-color:rgba(229,168,50,.3);color:var(--amber);">↻ Regen</div>
    <div class="sl-item" style="border-color:rgba(91,155,213,.3);color:var(--blue);">✦ AI edit</div>
    <div class="sl-item" style="border-color:rgba(217,107,107,.3);color:var(--rose);">✎ Manual</div>
  </div>
  <div class="products-table">
    <div class="pt-header">
      <div class="pt-th" style="text-align:left;">Product</div>
      <div class="pt-th">✓ First</div><div class="pt-th">↻ Regen</div>
      <div class="pt-th">✦ AI</div><div class="pt-th">✎ Manual</div>
      <div class="pt-th"></div>
    </div>
    <div id="products-list"></div>
  </div>
</div>

<script>
// ─── GOOGLE SHEETS SYNC ───
const GS_URL  = 'https://script.google.com/macros/s/AKfycbxDTt9AmEQcaZq5-jBw-vPl3LtpAv_8IfEc0trHMl40PTDqWdKh8Cy8XrMzqBcBoOLxxw/exec';
const POLL_MS = 2500;

const STATUS_META = {
  first:  {label:'✓',cls:'active-green',color:'var(--green)', bg:'var(--green-bg)',tag:'✓ First gen'},
  regen:  {label:'↻',cls:'active-amber',color:'var(--amber)', bg:'var(--amber-bg)',tag:'↻ Needs regen'},
  ai:     {label:'✦',cls:'active-blue', color:'var(--blue)',  bg:'var(--blue-bg)', tag:'✦ AI edit'},
  manual: {label:'✎',cls:'active-rose', color:'var(--rose)',  bg:'var(--rose-bg)', tag:'✎ Manual edit'},
};
const PALETTE = ['var(--green)','var(--amber)','var(--blue)','var(--rose)','var(--cream)'];
const COLORS  = ['#72C484','#E5A832','#5B9BD5','#D96B6B','#C8A8D9','#7FC5C0','#D9A86B'];
const ANIMALS = ['Fox','Owl','Bear','Lynx','Hawk','Wolf','Deer','Crane','Seal','Raven'];

const ME = {
  id:    Math.random().toString(36).slice(2,9),
  name:  ANIMALS[Math.floor(Math.random()*ANIMALS.length)],
  color: COLORS[Math.floor(Math.random()*COLORS.length)],
  view:  'overview'
};

let looks       = Array.from({length:26},(_,i)=>({id:i+1,products:[]}));
let presence    = {};
let currentLook = 0;
let lastHash    = '';
let isSaving    = false;
let saveQueue   = null;

const esc = s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const jh  = o=>JSON.stringify(o);
const totalRated  = ()=>{ let t=0; looks.forEach(l=>l.products.forEach(p=>{if(p.status)t++;})); return t; };
const countStatus = s=>{ let t=0; looks.forEach(l=>l.products.forEach(p=>{if(p.status===s)t++;})); return t; };
const lookCounts  = l=>{ const c={first:0,regen:0,ai:0,manual:0,unset:0}; l.products.forEach(p=>p.status?c[p.status]++:c.unset++); return c; };
function bump(id){ const el=document.getElementById(id); if(!el)return; el.classList.remove('bump'); void el.offsetWidth; el.classList.add('bump'); setTimeout(()=>el.classList.remove('bump'),300); }

function setBadge(state,label){ const b=document.getElementById('live-badge'),l=document.getElementById('live-label'); b.className='live-badge'+(state==='saving'?' syncing':state==='error'?' error':''); l.textContent=label; }
let toastTimer;
function showToast(msg,icon='✓'){ document.getElementById('toast-msg').textContent=msg; document.getElementById('toast-icon').textContent=icon; const t=document.getElementById('toast'); t.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'),2200); }
function pushActivity(name,color,msg){ const feed=document.getElementById('activity-feed'); const item=document.createElement('div'); item.className='activity-item'; item.innerHTML=`<div class="a-avatar" style="background:${color}22;color:${color};">${name[0]}</div><span style="color:#9A9086;">${esc(name)}</span>&nbsp;${esc(msg)}`; feed.appendChild(item); while(feed.children.length>4) feed.removeChild(feed.firstChild); setTimeout(()=>{ item.style.animation='fadeOut .4s ease forwards'; setTimeout(()=>item.remove(),400); },4000); }

// ─── GOOGLE SHEETS API ───
async function gsGet(){
  const res = await fetch(GS_URL, { redirect: 'follow' });
  if(!res.ok) throw new Error('get '+res.status);
  const text = await res.text();
  return JSON.parse(text);
}

async function gsSet(data){
  await fetch(GS_URL, {
    method:  'POST',
    mode:    'no-cors',
    headers: {'Content-Type':'text/plain'},
    body:    JSON.stringify(data)
  });
}

// ─── SAVE ───
function scheduleSave(msg){
  saveQueue = { looks: JSON.parse(jh(looks)), msg };
  if(!isSaving) flushSave();
}

async function flushSave(){
  if(!saveQueue) return;
  isSaving=true; setBadge('saving','Saving…');
  const payload=saveQueue; saveQueue=null;
  try {
    const p = {...(await gsGet().then(d=>d.presence||{}).catch(()=>({}))), [ME.id]:{name:ME.name,color:ME.color,view:ME.view,ts:Date.now()}};
    await gsSet({looks:payload.looks, presence:p, lastActor:ME.name, lastMsg:payload.msg, lastTs:Date.now()});
    lastHash = jh(payload.looks);
    setBadge('ok','Live'); showToast('Saved & synced');
  } catch(e){ setBadge('error','Retry…'); setTimeout(flushSave,3000); }
  finally { isSaving=false; if(saveQueue) flushSave(); }
}

// ─── POLL ───
async function poll(){
  try {
    const data = await gsGet();
    if(!data || !data.looks) return;

    const ih = jh(data.looks);
    if(ih !== lastHash){
      const prev = JSON.parse(jh(looks));
      looks = data.looks; lastHash = ih;
      const changed = looks.reduce((a,l,i)=>{ if(jh(l)!==jh(prev[i])) a.push(i); return a; },[]);
      const inOv = document.getElementById('overview').classList.contains('active');
      if(inOv){ renderOverview(); changed.forEach(i=>{ const c=document.getElementById('card-'+i); if(c){c.classList.remove('remote-flash');void c.offsetWidth;c.classList.add('remote-flash');} }); }
      else { renderGlobal(); if(changed.includes(currentLook)) renderDrill(true); }
      if(data.lastActor && data.lastActor!==ME.name && data.lastMsg){
        const u=Object.values(data.presence||{}).find(x=>x.name===data.lastActor);
        pushActivity(data.lastActor, u?u.color:'#C8BFB0', data.lastMsg);
      }
    }

    if(data.presence){
      const now=Date.now(), TTL=15000, fresh={};
      Object.entries(data.presence).forEach(([id,u])=>{ if(now-u.ts<TTL) fresh[id]=u; });
      Object.entries(fresh).forEach(([id,u])=>{ if(id!==ME.id&&!presence[id]) pushActivity(u.name,u.color,'joined'); });
      Object.entries(presence).forEach(([id,u])=>{ if(id!==ME.id&&!fresh[id]) pushActivity(u.name,u.color,'left'); });
      presence=fresh; renderPresence();
    }
    setBadge('ok','Live');
  } catch(e){ setBadge('error','Reconnecting…'); }
}

// ─── HEARTBEAT ───
async function heartbeat(){
  try {
    const data = await gsGet();
    const p = {...(data.presence||{}), [ME.id]:{name:ME.name,color:ME.color,view:ME.view,ts:Date.now()}};
    const now=Date.now(), fresh={};
    Object.entries(p).forEach(([id,u])=>{ if(now-u.ts<15000) fresh[id]=u; });
    await gsSet({...data, presence:fresh});
    presence=fresh; renderPresence();
  } catch(e){}
}

// ─── PRESENCE UI ───
function renderPresence(){
  document.getElementById('presence-bar').innerHTML=Object.values(presence).map(u=>`<div class="presence-avatar" style="background:${u.color}22;color:${u.color};">${u.name[0]}<div class="tip">${esc(u.name)} · ${u.view==='overview'?'Overview':u.view.replace('look:','Look ')}</div></div>`).join('');
  const n=Object.values(presence).filter(u=>u.id!==ME.id).length;
  document.getElementById('online-count').textContent=n>0?`+${n} online`:'';
  renderWhosHere();
}
function renderWhosHere(){
  const panel=document.getElementById('whos-here-drill');
  const viewers=Object.values(presence).filter(u=>u.view==='look:'+currentLook&&u.id!==ME.id);
  if(!viewers.length){panel.style.display='none';return;}
  panel.style.display='flex';
  panel.innerHTML=`<span class="wh-label">Also here:</span>`+viewers.map(u=>`<div class="presence-avatar" style="width:22px;height:22px;font-size:9px;background:${u.color}22;color:${u.color};">${u.name[0]}<div class="tip">${esc(u.name)}</div></div>`).join('');
}

// ─── RENDER ───
function renderGlobal(){
  const total=totalRated(),pct=v=>total>0?Math.round(v/total*100)+'%':'0%';
  ['first','regen','ai','manual'].forEach(s=>{ const n=countStatus(s); document.getElementById('g-'+s).textContent=n; document.getElementById('g-'+s+'-pct').textContent=pct(n); document.getElementById('hbar-'+s).style.width=(total>0?n/total*100:0)+'%'; });
  document.getElementById('hdr-logged').textContent=looks.filter(l=>l.products.length>0).length+'/26';
  document.getElementById('hdr-products').textContent=looks.reduce((a,l)=>a+l.products.length,0);
}
function renderOverview(){
  renderGlobal(); const grid=document.getElementById('looks-grid'); grid.innerHTML='';
  looks.forEach((l,i)=>{ const c=lookCounts(l),total=l.products.length,rated=total-c.unset,viewers=Object.values(presence).filter(u=>u.view==='look:'+i&&u.id!==ME.id); const card=document.createElement('div'); card.className='look-card'+((c.regen+c.ai+c.manual)>0?' has-issues':total>0&&c.unset===0?' all-done':''); card.id='card-'+i; card.onclick=()=>openDrill(i); let ph=''; if(!total) ph='<div class="lc-empty">No products yet</div>'; else{ l.products.slice(0,4).forEach(p=>{ const sm=p.status?STATUS_META[p.status]:null; ph+=`<div class="lc-product"><div class="lc-pname">${esc(p.name)}</div>${sm?`<div class="lc-status" style="background:${sm.bg};color:${sm.color};">${sm.label}</div>`:`<div class="lc-status" style="background:var(--faint);color:var(--muted);">·</div>`}</div>`; }); if(total>4) ph+=`<div class="lc-empty">+${total-4} more</div>`; } let bh=''; if(rated>0) ['first','regen','ai','manual'].forEach(s=>{ const w=c[s]/rated*100,col={first:'green',regen:'amber',ai:'blue',manual:'rose'}[s]; if(w>0) bh+=`<div class="lc-bar-seg bg-${col}" style="width:${w}%"></div>`; }); card.innerHTML=`${viewers.length?`<div class="lc-viewers">${viewers.map(u=>`<div class="lc-viewer-dot" title="${esc(u.name)}" style="background:${u.color};"></div>`).join('')}</div>`:''}<div class="lc-num" style="color:${PALETTE[i%PALETTE.length]};">Look ${String(l.id).padStart(2,'0')}</div><div class="lc-products">${ph}</div><div class="lc-footer"><div class="lc-bar">${bh}</div><div class="lc-edit">${total?rated+'/'+total+' rated':'Add →'} <span class="lc-arrow">→</span></div></div>`; grid.appendChild(card); });
}
function openDrill(idx){ currentLook=idx; ME.view='look:'+idx; document.getElementById('overview').classList.remove('active'); document.getElementById('drill').classList.add('active'); document.getElementById('d-title').textContent='Look '+looks[idx].id; document.getElementById('new-product-input').value=''; renderDrill(); setTimeout(()=>document.getElementById('new-product-input').focus(),100); }
function goOverview(){ ME.view='overview'; document.getElementById('drill').classList.remove('active'); document.getElementById('overview').classList.add('active'); renderOverview(); }
function renderDrill(fromRemote=false){
  renderGlobal(); renderWhosHere();
  const l=looks[currentLook],c=lookCounts(l),rated=l.products.length-c.unset;
  document.getElementById('d-sub').textContent=!l.products.length?'Add each product in this look, then set its generation status':`${l.products.length} product${l.products.length!==1?'s':''} · ${rated} rated`;
  const list=document.getElementById('products-list'); list.innerHTML='';
  if(!l.products.length){list.innerHTML='<div class="empty-state">No products yet — add the first one above</div>';return;}
  l.products.forEach((p,pi)=>{ const row=document.createElement('div'); row.className='product-row'+(fromRemote?' remote-updated':''); row.id='pr-'+pi; const btns=['first','regen','ai','manual'].map(s=>{ const m=STATUS_META[s]; return `<button class="status-btn ${p.status===s?m.cls:''}" onclick="setStatus(${pi},'${s}')">${m.label}</button>`; }).join(''); row.innerHTML=`<div><div class="pr-name" contenteditable="true" spellcheck="false" style="outline:none;border-bottom:1px dashed transparent;transition:border-color .15s;cursor:text;" onmouseover="this.style.borderColor='var(--border2)'" onmouseout="if(document.activeElement!==this)this.style.borderColor='transparent'" onfocus="this.style.borderColor='var(--muted)'" onblur="this.style.borderColor='transparent';renameProduct(${pi},this.textContent.trim())" onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}">${esc(p.name)}</div>${p.status?`<div class="pr-tag" style="color:${STATUS_META[p.status].color}">${STATUS_META[p.status].tag}</div>`:''}</div>${btns}<button class="del-btn" onclick="deleteProduct(${pi})">×</button>`; list.appendChild(row); });
}
function setStatus(pi,status){ const l=looks[currentLook],prev=l.products[pi].status; l.products[pi].status=prev===status?null:status; if(l.products[pi].status) bump('g-'+l.products[pi].status); renderDrill(); const row=document.getElementById('pr-'+pi); if(row){row.classList.remove('remote-updated');void row.offsetWidth;row.classList.add('remote-updated');} scheduleSave(`marked "${l.products[pi].name}" as ${l.products[pi].status||'unset'}`); }
function addProduct(){ const input=document.getElementById('new-product-input'),name=input.value.trim(); if(!name){input.style.borderColor='var(--rose)';setTimeout(()=>input.style.borderColor='',600);return;} looks[currentLook].products.push({name,status:null}); input.value=''; input.focus(); renderDrill(); scheduleSave(`added "${name}" to Look ${looks[currentLook].id}`); }
function renameProduct(pi,name){ if(!name||name===looks[currentLook].products[pi].name) return; const old=looks[currentLook].products[pi].name; looks[currentLook].products[pi].name=name; scheduleSave(`renamed "${old}" → "${name}"`); }
function deleteProduct(pi){ const name=looks[currentLook].products[pi].name; looks[currentLook].products.splice(pi,1); renderDrill(); scheduleSave(`removed "${name}"`); }

// ─── INIT ───
(async()=>{
  setBadge('saving','Connecting…');
  try {
    const data = await gsGet();
    if(data && Array.isArray(data.looks) && data.looks.length===26){
      looks=data.looks; lastHash=jh(looks); presence=data.presence||{};
    } else {
      const init=Array.from({length:26},(_,i)=>({id:i+1,products:[]}));
      await gsSet({looks:init,presence:{},lastActor:'',lastMsg:'',lastTs:Date.now()});
      looks=init; lastHash=jh(looks);
    }
    setBadge('ok','Live');
  } catch(e){ setBadge('error','Cannot connect'); console.error(e); }
  renderOverview();
  await heartbeat();
  pushActivity(ME.name, ME.color, 'joined the session');
  setInterval(poll, POLL_MS);
  setInterval(heartbeat, 8000);
})();
</script>
</body>
</html>
